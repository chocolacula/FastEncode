#pragma once

#include <stdint.h>
#include "../EncryptionBase.h"

class Blowfish_default final : public EncryptionBase
{
private:
	uint32_t _sBox1[256] = { 2288664356, 3540558725, 780802323, 1148416003, 574097828, 3492912937, 2566532616, 2305576684, 3860932677, 1997787192, 3479590078, 1812785460, 3072961728, 3713039561, 3050669119, 386484149, 3654620818, 469465481, 2785751505, 2897600408, 3681746223, 3084851920, 3987726776, 2524849770, 1167097018, 2575248625, 1201250596, 4151087539, 3807510792, 385650309, 3626002787, 1766741873, 2751355044, 2117964788, 2406782221, 1488359026, 1489865585, 3997832578, 497308795, 3042532034, 970272924, 325120554, 598790597, 4035272744, 410599882, 4013480888, 2967239054, 236468832, 2332991084, 1049239216, 3245807063, 659239357, 3660558200, 1616666709, 4079310310, 2494256554, 1654147159, 1075112035, 1782172245, 3054545706, 878496948, 3471327505, 2944816289, 2481549948, 286584499, 716992355, 1573234987, 4130412660, 373185742, 512984987, 867882671, 1557079148, 2169713274, 2005308712, 2554892091, 2948156267, 468238276, 2468423782, 3423197281, 2443780603, 1621916744, 847309917, 1566409967, 2977269225, 35858140, 2283496939, 2168359203, 3316422355, 4084165903, 960689283, 2185497390, 69239972, 1257293929, 1587224478, 1114162721, 2590829046, 1637616743, 4035498923, 3533721962, 1747932376, 682037142, 2738049451, 1812721518, 3829103123, 1357921210, 2552953726, 493220257, 1979821881, 1046071910, 2282636162, 428273292, 3030347589, 3282404477, 3193867067, 3631575008, 1931526533, 2672040512, 2792014166, 1655362382, 108478262, 1927282203, 1023580994, 618123319, 1209141968, 3555332059, 2613113161, 3379712775, 2065406336, 3631862821, 4158580982, 441515747, 994867638, 3185601687, 3121004548, 3058674113, 3294666560, 3265158238, 1663330841, 2943351656, 3042143294, 3954325779, 1877758523, 525466733, 747974811, 1145405900, 163405487, 80798654, 4249498590, 120065894, 3008048665, 1470680000, 259311685, 962530258, 3690714041, 3183507797, 171073562, 3321930198, 2037525568, 4263878503, 3433242619, 4176061838, 4162990811, 3742790972, 359358973, 3357429807, 2874279341, 4206181682, 1619469309, 1216033107, 2195652670, 3143064734, 2693558218, 777422618, 3681097695, 4138222293, 3288301096, 3325192108, 1934970764, 2955369321, 3361262267, 1571028961, 2685530296, 2554198544, 3095601661, 1823865930, 1540608301, 2045006746, 1699084470, 3158937298, 2425879371, 3673349601, 863947684, 1091828578, 3905348814, 3670679791, 21788470, 4271800016, 3021992235, 1306188693, 2559676590, 1905176042, 2698351467, 3503394512, 3760572335, 794508430, 3079959950, 4225955471, 1680544498, 314083464, 485494160, 2690559311, 482578280, 2448543697, 2915150003, 404893487, 1997999806, 4264392170, 2703164043, 265068773, 3899944885, 3606293528, 2581760462, 3763316916, 3084915709, 2168177788, 3651710418, 1721917206, 91723136, 343133331, 1997806113, 1696640486, 2264577399, 4114764999, 3476397563, 212848107, 2693348987, 3541778902, 1233002158, 755901696, 1588818208, 3137366050, 2950740055, 2604033060, 515443184, 496067413, 2863062873, 2302919032, 2136169177, 2723904800, 3317294338, 1979917955, 2848953698, 1746520081, 1095398222, 3391965107, 1252594811 };
	uint32_t _sBox2[256] = { 1375752475, 355029914, 1062670294, 3838221244, 1990484011, 7661185, 3043998216, 535370583, 1810667250, 366546218, 560292790, 3069819367, 772093183, 1683391941, 1563275347, 2710544297, 2571614728, 1778877806, 3916462667, 1143583669, 772371931, 589699524, 2963697325, 2111809353, 3093360284, 1723002255, 1905044204, 4279736937, 1817338966, 3785273794, 2768385561, 692849013, 1075009952, 1043994852, 2593674303, 1704804955, 3605303147, 3594516377, 127718049, 4113623279, 3862441293, 3244107248, 2250300748, 652963972, 3337192035, 1590435330, 1064003593, 3387931198, 337155900, 2708499051, 2218098536, 2262999122, 89365687, 923226282, 478414654, 1554964095, 3963911566, 3102873175, 937048752, 218910960, 69147888, 4289921026, 452267182, 2993993020, 1484423973, 3173059036, 4178809297, 4130318716, 1934045844, 21493026, 2179327290, 3705324087, 880195016, 2816340890, 1180779689, 235130895, 1053280492, 1092515236, 2580363490, 789506619, 2713419826, 833830424, 948655182, 146369871, 51200623, 3204713206, 2417145900, 2038208292, 1924168022, 2945036220, 527932126, 268997593, 313428915, 775933916, 527569493, 611412782, 3873249872, 2278392991, 407328890, 400164980, 3164250044, 2357021673, 988576492, 4196238811, 1715669347, 3536020676, 1192762607, 148444466, 926630877, 381338148, 1129160978, 1371825450, 33592400, 3722721811, 2667110257, 1431187728, 3598167169, 2602111327, 4048958724, 1808245719, 991433020, 161817689, 3991310322, 4210815383, 750762654, 1849431326, 1883628422, 2976901610, 173936262, 3005890138, 484908919, 4194712910, 3118228777, 253618073, 3599318656, 633890386, 2026458158, 1790120092, 3121485254, 2028659348, 1396505765, 4096592414, 2806970354, 1026235702, 254163225, 1618592281, 145171282, 3054638071, 1862184427, 1713357802, 2504375523, 2210954150, 3510075313, 687836161, 4024251075, 2774166718, 2233555045, 43559784, 262524654, 999632859, 2910711594, 2217700955, 683024661, 1885407017, 1967644140, 269852513, 816368659, 2528993771, 519975939, 3479372714, 2421978037, 966946892, 194944725, 350137035, 3162950894, 2804703840, 2874977180, 1854206898, 2938014564, 3404774681, 3110675360, 1354455653, 844785728, 3014928956, 3588857393, 4156039616, 420172955, 2577424263, 2124019605, 2826780002, 2592618488, 1999496087, 1603530001, 2165467158, 696792334, 3592414919, 2715803286, 2579126392, 2776954199, 1668424219, 4291003291, 2521219610, 3943347149, 1412443731, 3829979535, 674348141, 4025674584, 3942630964, 1642932478, 1933343982, 3641985629, 3820446952, 341643330, 3759357472, 3068325445, 3937118883, 357526747, 3494890490, 1123304135, 3048958703, 490426213, 86101313, 2658737880, 3343746438, 1783057380, 1348632893, 4070662863, 1176931675, 2692974844, 2746664897, 3273921919, 2457127785, 193627207, 2243072598, 12540681, 2638748077, 1957782036, 950819, 713900632, 3941946636, 1056222493, 1634746147, 2465231411, 1098814349, 4058800086, 3678085740, 1496833660, 1618276043, 2817688896, 1848801230, 2222983078, 2656106521, 1440280552, 899144033, 2863098281, 3255176389 };
	uint32_t _sBox3[256] = { 2577216553, 2935321871, 2839149042, 649695635, 90691069, 3382582798, 3554374619, 3448263952, 2044354407, 1078159331, 1697957061, 3627564657, 2667063357, 553610737, 3877715477, 1245556879, 731898854, 4155343835, 1750744553, 4148199828, 472272118, 875129236, 4146074945, 4157866614, 778826940, 1744872148, 1898186964, 1794383923, 3084171075, 2942369872, 787888414, 1178936471, 1951342868, 1082690495, 503092557, 2945562006, 3554538608, 1160749158, 3960061119, 2241314051, 3496848511, 75877169, 3005737878, 1094319445, 3863422426, 2584398507, 628641832, 4096328787, 3666226186, 4218271465, 1645534312, 6899927, 2764050024, 4002259239, 2734571343, 2360182760, 115379381, 3067540602, 2082393770, 3965663187, 2577627342, 1110076224, 899612192, 3112563673, 2883009006, 2337149499, 4160407837, 1444441419, 828810022, 2996298730, 1962569274, 843275229, 4159127912, 4213209290, 1324681979, 2545155800, 2891333701, 664094906, 976900949, 2274198304, 3081333758, 1268094672, 3160909909, 1486493089, 1663674828, 870048153, 1447701158, 4179964223, 478082142, 2083596688, 48822525, 1882138372, 1544928128, 3811321861, 1209385365, 577619684, 1058259272, 3699773383, 4006213895, 253690945, 2759411520, 393119837, 3947978546, 3519060949, 2411838706, 1681199425, 880311077, 1620847200, 2749954271, 460088095, 3266581006, 2654134530, 3511641775, 360829386, 3767870315, 3784457779, 1644897339, 582598382, 245543557, 2567813862, 2349626078, 687317549, 1165497040, 4254381973, 1644723556, 4042640615, 1872972116, 4199054727, 670932419, 512573171, 1097025290, 1962880665, 2876141370, 939391220, 1625035432, 4175293345, 1289821081, 225144539, 274037702, 925656941, 1003775271, 82366684, 3339528689, 2751398092, 2450471349, 200085353, 4221533030, 2625493966, 198152608, 2740852185, 2284786619, 615340881, 3212416123, 3956685686, 3006150967, 2035880396, 2548180608, 758198004, 2813149800, 992701126, 3427562770, 485568120, 927076970, 3880882871, 3871056134, 1348729675, 403729178, 4209887761, 3636274493, 3385057762, 1494630980, 2249396746, 1860963545, 720022485, 1315417956, 1604880090, 2297020350, 4274250852, 1468054685, 2260793328, 4168841312, 1298137952, 1183055313, 2954836214, 78529911, 3439081175, 862667395, 1907039984, 2269216944, 1599995964, 3193413751, 615442621, 2571257429, 1630427327, 2415155278, 2734546418, 955217140, 3267201415, 3287901779, 1955509192, 1441953204, 3118070854, 1629940602, 2229214603, 2030987908, 3801440145, 2388225606, 1884795936, 2438321548, 1289618121, 3786148793, 3490022075, 1214425105, 2661905525, 3055124407, 165456352, 2701733222, 860238532, 35609320, 2361323529, 631281994, 285109789, 490584346, 3752109323, 267552417, 1777428520, 2212149212, 4261820759, 2614026913, 1384107343, 22942032, 4202890919, 3300197024, 668001805, 663550106, 1099317111, 105668803, 3037112417, 679090160, 3766941120, 2857918464, 1652415536, 3617515025, 1676294179, 2497561171, 873906882, 1458490299, 3736517776, 2709388523, 1981635022, 165938543, 2281798731, 1024094777, 612143740, 1601364870, 3114093938 };
	uint32_t _sBox4[256] = { 2597800047, 1700450271, 3240911648, 50798850, 3025912090, 4239957715, 2018858221, 3047554056, 3642000802, 1007898988, 3888633199, 3293503830, 3468634678, 935904989, 875731671, 310535058, 2398752359, 3758121024, 936261946, 3489004243, 930595499, 455984474, 2657595484, 1110942543, 1076331219, 3197877401, 2643333589, 359862207, 2115775958, 2076442823, 1796967607, 1167106337, 3199299250, 3027121770, 799754327, 2037290172, 3530990534, 3368175973, 4009234259, 2111737158, 487224277, 3326988364, 3686480169, 1346812585, 3894842796, 82009790, 4040555169, 2589011306, 3800887139, 586057370, 3099756992, 4130219075, 2852331173, 2765157020, 3126968451, 1298852251, 1343612303, 3596313786, 4188153384, 3778689703, 2257955147, 3915535855, 3555667911, 3673641719, 1768883263, 1493891703, 363455616, 25604231, 2917534107, 2481274427, 1526567145, 2547463326, 3652710444, 1368075010, 984405398, 2108062977, 3594440657, 674069884, 3475349279, 2612589229, 1924453978, 1291159642, 1907108320, 3869579744, 4255952967, 2616890349, 2378486760, 3428268840, 694605304, 674108281, 2432786296, 1432385005, 1141806839, 2355024867, 3563914517, 3127768200, 627155203, 3186648069, 362736579, 2723647548, 3961137047, 705116841, 2607628059, 4112605982, 4217806069, 435412006, 685323125, 4127020465, 2184467971, 3141319306, 293032232, 4174973634, 1733414059, 1603448268, 1360521293, 2396794936, 1649974583, 2449023123, 3264248554, 3464183547, 1691230545, 851332983, 2128852648, 1178413507, 1767104072, 2162561892, 269004450, 615673309, 4247618921, 1713440521, 172399283, 3720365412, 3487460440, 2932351004, 3724000859, 1083004955, 2130825932, 3152262251, 2120917725, 1174362426, 1141519678, 3587028156, 2832132722, 3146015994, 2920441485, 1198472383, 1675926482, 2656907092, 460833454, 1885556470, 2366443124, 1460886503, 1897296632, 1568494511, 147537984, 3437409358, 1783026228, 2226066689, 671396065, 490379413, 3030366214, 1218473678, 2184920943, 2192252981, 1260198401, 4163334695, 2975864161, 3695154151, 729365179, 3173336372, 3778644128, 1266273873, 3083416111, 3384418208, 2127043808, 4140943292, 3272671695, 3349866657, 1233621018, 2596098004, 3420379856, 953813717, 717437187, 1731629510, 2083649933, 1328263648, 3076103927, 985396547, 4279883250, 2621823271, 740464575, 721217045, 1912377615, 622171291, 1637082618, 3952916174, 1499769026, 3517495826, 1577566646, 208274915, 1699795472, 1118045131, 242150624, 1004247062, 3198195788, 1693022258, 848633759, 3750941664, 724869331, 519205257, 1098123803, 2352259915, 544325317, 3627185859, 2376021471, 774871451, 1198459878, 502391567, 1423592677, 2446907934, 3480838862, 1870544589, 1722882070, 85798141, 3318910852, 2569206774, 1475552245, 594948774, 825600147, 47041622, 1652682924, 3052107098, 2536904302, 3430142600, 2455934686, 3494492545, 462442572, 341231217, 3183986406, 169114162, 114352453, 2591814339, 4250118857, 1026146, 3804177851, 4141006133, 90772081, 570557618, 2093992886, 731674317, 3225293139, 3554885654, 1623042872, 4037887781, 2619357370, 1993230071 };
	
	uint32_t _pKey[18] = { 256960882, 252050925, 4103194415, 2778761092, 3315707767, 1616934176, 1325321093, 3633178762, 2969152122, 2125134156, 1556236313, 2357918466, 757401919, 2682652866, 845237943, 1541568462, 3823079255, 3866280762 };

	uint8_t _x32End;
	uint8_t _x64End;

	/* MSVC 14.22 doesn't inline small private functions automatically with any options set
	 *	+ Any Suitable (/Ob2) +
	 *	Blowfish_default_encrypt         43931408 ns     43619792 ns           24
	 *	+ Default +
	 *	Blowfish_default_encrypt         42324758 ns     42279412 ns           17
	 *	+ Manual inline +
	 *	Blowfish_default_encrypt         21301574 ns     20996094 ns           32
	 */

	virtual inline void EncryptMain(const uint8_t*& clear, uint32_t clearSize, uint8_t*& encrypted);
	virtual inline void DecryptMain(const uint8_t*& encrypted, uint32_t encryptedSize, uint8_t*& clear);

	inline void Encrypt128(const uint8_t* clear, uint8_t* encrypted);
	inline void Decrypt128(const uint8_t* encrypted, uint8_t* clear);

	virtual inline void Encrypt64(const uint8_t* clear, uint8_t* encrypted);
	virtual inline void Decrypt64(const uint8_t* encrypted, uint8_t* clear);

	virtual inline void Encrypt32(const uint8_t* clear, uint8_t* encrypted);
	virtual inline void Decrypt32(const uint8_t* encrypted, uint8_t* clear);

	inline uint64_t F64(uint64_t block);
	inline uint32_t F32(uint32_t block);
	inline uint16_t F16(uint16_t block);

public:
	enum class Reliability
	{
		Strong = 17,
		Medium = 13,
		Weak = 9
	};

	Blowfish_default(const uint8_t* password, uint32_t length, Reliability reliability);

	void SetPassword(const uint8_t* password, uint32_t length);
	void SetReliability(Reliability reliability);
};